
<script>
    $(document).ready(function() {
        // Initialize Flatpickr
        flatpickr("#start-date", {
            dateFormat: "Y-m-d",
            allowInput: true,
        });
        flatpickr("#end-date", {
            dateFormat: "Y-m-d",
            allowInput: true,
        });

        // Custom function to parse the custom date format
        function parseCustomDateFormat(dateStr) {
            if (!dateStr) {
                console.log('Date string is empty or undefined.');
                return NaN;
            }

            console.log('Original date string:', dateStr);

            // Split into date and time parts
            const dateTimeParts = dateStr.split(', ');
            if (dateTimeParts.length !== 3) {
                console.log('Date string does not have the expected format.');
                return NaN;
            }

            const monthDayYear = dateTimeParts[0] + ' ' + dateTimeParts[1]; // Combine month and day parts
            const time = dateTimeParts[2];

            // Split date part into month, day, and year
            const monthDayYearParts = monthDayYear.split(' ');
            if (monthDayYearParts.length < 3) {
                console.log('Month, day, and year are not correctly split.');
                return NaN;
            }

            // Split time part into hour, minute, and meridiem
            const timeParts = time.split(' ');
            if (timeParts.length !== 2) {
                console.log('Time is not correctly split into hour and minute.');
                return NaN;
            }

            const [month, day, year] = [monthDayYearParts[0], monthDayYearParts[1].replace(',', ''), monthDayYearParts[2]];
            const [hourMinute, meridiem] = timeParts;
            const [hour, minute] = hourMinute.split(':');

            console.log('Parsed month:', month);
            console.log('Parsed day:', day);
            console.log('Parsed year:', year);
            console.log('Parsed hour:', hour);
            console.log('Parsed minute:', minute);
            console.log('Parsed meridiem:', meridiem);

            // Convert month name to month number
            const months = {
                January: 0, February: 1, March: 2, April: 3, May: 4, June: 5,
                July: 6, August: 7, September: 8, October: 9, November: 10, December: 11
            };

            if (!months.hasOwnProperty(month)) {
                console.log('Invalid month name.');
                return NaN;
            }

            let parsedHour = parseInt(hour);
            if (meridiem.toLowerCase() === 'p.m.' && parsedHour !== 12) {
                parsedHour += 12;
            } else if (meridiem.toLowerCase() === 'a.m.' && parsedHour === 12) {
                parsedHour = 0;
            }

            const dateObject = new Date(year, months[month], parseInt(day), parsedHour, parseInt(minute));
            console.log('Parsed date object:', dateObject);

            return dateObject.getTime();
        }

        // Custom filtering function to filter data based on date range
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                var min = $('#start-date').val();
                var max = $('#end-date').val();
                var dateStr = data[7]; // Use data for the date column (index 9 in the table)

                // Convert input dates to comparable format
                if (min) {
                    min = new Date(min).setHours(0, 0, 0, 0);
                }
                if (max) {
                    max = new Date(max).setHours(23, 59, 59, 999);
                }

                // Convert table date string to timestamp
                var date = parseCustomDateFormat(dateStr);

                console.log('Min:', min);
                console.log('Max:', max);
                console.log('Date String:', dateStr);
                console.log('Date:', date);

                if (isNaN(date)) {
                    return false; // Skip rows with invalid date
                }

                if (
                    (min === '' && max === '') ||
                    (min === '' && date <= max) ||
                    (min <= date && max === '') ||
                    (min <= date && date <= max)
                ) {
                    return true;
                }
                return false;
            }
        );

        // Initialize DataTable
        var table = $('#client_account_statement').DataTable();

        // Event listener to redraw the table when the date range changes
        $('#start-date, #end-date').on('change', function() {
            table.draw();
        });
    
    
        $('#client_statement_exportBtn').click(function() {

            // var filteredData = table.rows({ filter: 'applied' }).data().toArray();
            var filteredData = table.rows({ filter: 'applied' }).nodes().toArray();

            console.log('Filtered Data:', filteredData);
        

        if (filteredData){

            var data = [];
            var headers = [
                "Sr.No",
                "Narration",
                "Deposit",
                "Withdraw",
                "Status",
                "Balance",
                "Created Date",
                " ",
                "Name",
                "Account Number",
                "Bank Name",
                "Bene IFSC Code"
            ];
            data.push(headers);
            
            // Process the filtered data
            $.each(filteredData, function(index, row) {
                var $row = $(row);
                var $button = $row.find('button.open-popup-btn');

                var entry = {
                    narration: $row.find('td').eq(1).text(),
                    deposit: $row.find('td').eq(2).text(),
                    withdraw: $row.find('td').eq(3).text(),
                    status: $row.find('td').eq(4).text(),
                    balance: $row.find('td').eq(5).text(),
                   

                    created_at: $row.find('td').eq(7).text(),
                    is_wallet: $button.data('bene-mode') === 'wallet', // Determine if it is a wallet entry based on the data-bene-mode
                    bene_account_name: $button.data('bene-name'),
                    bene_account_number: $button.data('bene-account-number'),
                    bene_bank_name: $button.data('bene-bank-name'),
                    bene_branch_ifsc: $button.data('bene-ifsc-code')
                };



                var rowData = [];
                console.log("ENTERY", entry);
                if (entry.is_wallet) {
                    // Process client wallet statement
                    rowData.push(index + 1); // Serial number
                    rowData.push(entry.narration);
                    rowData.push(entry.deposit);
                    rowData.push(entry.withdraw);
                    rowData.push(entry.status);
                    rowData.push(entry.balance);
                    rowData.push(entry.created_at);
                    rowData.push(''); 
                    
                    rowData.push(''); // Bene Name
                    rowData.push(''); // Bene Account Number
                    rowData.push(''); // Bene Bank Name
                    rowData.push(''); // Bene IFSC Code
                } else {
                    // Process withdrawal request
                    rowData.push(index + 1); // Serial number
                    rowData.push(entry.narration);
                    rowData.push(entry.deposit);
                    rowData.push(entry.withdraw);
                    rowData.push(entry.status);
                    rowData.push(entry.balance);
                    rowData.push(entry.created_at);
                    rowData.push('');

                    rowData.push(entry.bene_account_name);
                    rowData.push(entry.bene_account_number);
                    rowData.push(entry.bene_bank_name);
                    rowData.push(entry.bene_branch_ifsc);
                    
                }
                data.push(rowData);
            });

            // Convert the extracted data to a worksheet
            var worksheet = XLSX.utils.aoa_to_sheet(data);

            // Create a new workbook and append the worksheet
            var workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');

            // Export the workbook to an Excel file
            XLSX.writeFile(workbook, 'client_account_statement.xlsx');
        

        }

       

            



    });








    });
</script>
